#!/bin/bash

# Usage: create-codespace <github-org-or-user>/<repo> [branch]

REPO=$1
BRANCH=${2:-main}

if [ -z "$REPO" ]; then
  echo "Usage: $0 <owner>/<repo> [branch]"
  exit 1
fi

# Check if gh is installed
if ! command -v gh &>/dev/null; then
  echo "GitHub CLI (gh) is not installed. Please install it first."
  exit 1
fi

echo "Creating Codespace for $REPO on branch $BRANCH..."

# Create the codespace
gh codespace create --repo "$REPO" --branch "$BRANCH" --status

# Wait for it to initialize
echo "Waiting for Codespace to be ready..."
sleep 5

# List most recent codespace for this repo
CODESPACE_NAME=$(gh codespace list --repo "$REPO" --json name -q '.[0].name')

if [ -z "$CODESPACE_NAME" ]; then
  echo "❌ Failed to find a running codespace for $REPO"
  exit 1
fi

echo "✅ Codespace ready: $CODESPACE_NAME"
echo "Opening in VS Code..."

# Open in VS Code
gh codespace code --codespace "$CODESPACE_NAME"
